<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='content-type'>
    <title>
      Kjell-Magne Øierud :: bliki :: IPv6 addresses and MySQL
    </title>
    <link href='/bliki/feed.atom' rel='alternate' title='Feed' type='application/atom+xml'>
    <link href='/css/coderay.css' rel='stylesheet' type='text/css'>
    <link href='/css/site.css' media='screen, projection' rel='stylesheet' type='text/css'>
    <script src='/main.js' type='text/javascript'></script>
  </head>
  <body>
    <div id='container'>
      <h1>Kjell-Magne Øierud :: Bliki</h1>
      <p id='subtitle'>Thoughts on software development</p>
      <div id='menu'>
        <span style="float:left;">[ <a href="..">Home</a> ] [ <a href="."><strong>Blog</strong></a> ] </span><span style="float: right;">[ <a href="feed.atom">Feed</a> ]</span>
      </div>
      <div class="date">
        2009-02-19 11:49 CET
      </div>
      <h2>
        IPv6 addresses and MySQL
      </h2>
      
      
      <p>I usually prefer storing IP addresses as integers (unless the DBMS
        have a special data type for it). Using integers gives compact
        storage and makes it easy to answer questions like what is the next
        IP address? In which subnets does it belong? Etc. IPv6 addresses is
        128 bits long, so to store that as an integer in MySQL you need to
        use the <code>DECIMAL</code> data type.
      
      </p><p>In MySQL there is two functions that help you translate between the
        familiar canonical version and the numeric version of IP addresses:
        INET_ATON() and INET_NTOA(). However these functions do not work
        with IPv6 addresses.
      
      </p><p>One possible solution to this is to implement INET_ATON6() and
      INET_NTOA6() yourself as stored functions:
      
      </p><h3>INET_ATON6</h3>
      
      <pre class="CodeRay"><code class="language-sql">DELIMITER //&#x000A;<span class="r">CREATE</span> FUNCTION INET_ATON6(n <span class="pt">CHAR</span>(<span class="i">39</span>))&#x000A;RETURNS <span class="pt">DECIMAL</span>(<span class="i">39</span>) <span class="pt">UNSIGNED</span>&#x000A;DETERMINISTIC&#x000A;<span class="r">BEGIN</span>&#x000A;    RETURN <span class="pd">CAST</span>(CONV(SUBSTRING(n <span class="r">FROM</span>  <span class="i">1</span> FOR <span class="i">4</span>), <span class="i">16</span>, <span class="i">10</span>) <span class="r">AS</span> <span class="pt">DECIMAL</span>(<span class="i">39</span>))&#x000A;                       * <span class="i">5192296858534827628530496329220096</span> <span class="c">-- 65536 ^ 7</span>&#x000A;         + <span class="pd">CAST</span>(CONV(SUBSTRING(n <span class="r">FROM</span>  <span class="i">6</span> FOR <span class="i">4</span>), <span class="i">16</span>, <span class="i">10</span>) <span class="r">AS</span> <span class="pt">DECIMAL</span>(<span class="i">39</span>))&#x000A;                       *      <span class="i">79228162514264337593543950336</span> <span class="c">-- 65536 ^ 6</span>&#x000A;         + <span class="pd">CAST</span>(CONV(SUBSTRING(n <span class="r">FROM</span> <span class="i">11</span> FOR <span class="i">4</span>), <span class="i">16</span>, <span class="i">10</span>) <span class="r">AS</span> <span class="pt">DECIMAL</span>(<span class="i">39</span>))&#x000A;                       *          <span class="i">1208925819614629174706176</span> <span class="c">-- 65536 ^ 5</span>&#x000A;         + <span class="pd">CAST</span>(CONV(SUBSTRING(n <span class="r">FROM</span> <span class="i">16</span> FOR <span class="i">4</span>), <span class="i">16</span>, <span class="i">10</span>) <span class="r">AS</span> <span class="pt">DECIMAL</span>(<span class="i">39</span>)) &#x000A;                       *               <span class="i">18446744073709551616</span> <span class="c">-- 65536 ^ 4</span>&#x000A;         + <span class="pd">CAST</span>(CONV(SUBSTRING(n <span class="r">FROM</span> <span class="i">21</span> FOR <span class="i">4</span>), <span class="i">16</span>, <span class="i">10</span>) <span class="r">AS</span> <span class="pt">DECIMAL</span>(<span class="i">39</span>))&#x000A;                       *                    <span class="i">281474976710656</span> <span class="c">-- 65536 ^ 3</span>&#x000A;         + <span class="pd">CAST</span>(CONV(SUBSTRING(n <span class="r">FROM</span> <span class="i">26</span> FOR <span class="i">4</span>), <span class="i">16</span>, <span class="i">10</span>) <span class="r">AS</span> <span class="pt">DECIMAL</span>(<span class="i">39</span>))&#x000A;                       *                         <span class="i">4294967296</span> <span class="c">-- 65536 ^ 2</span>&#x000A;         + <span class="pd">CAST</span>(CONV(SUBSTRING(n <span class="r">FROM</span> <span class="i">31</span> FOR <span class="i">4</span>), <span class="i">16</span>, <span class="i">10</span>) <span class="r">AS</span> <span class="pt">DECIMAL</span>(<span class="i">39</span>))&#x000A;                       *                              <span class="i">65536</span> <span class="c">-- 65536 ^ 1</span>&#x000A;         + <span class="pd">CAST</span>(CONV(SUBSTRING(n <span class="r">FROM</span> <span class="i">36</span> FOR <span class="i">4</span>), <span class="i">16</span>, <span class="i">10</span>) <span class="r">AS</span> <span class="pt">DECIMAL</span>(<span class="i">39</span>))&#x000A;         ;&#x000A;<span class="r">END</span>;&#x000A;//&#x000A;DELIMITER ;</code></pre>
      
      
      <h3>INET_NTOA6</h3>
      <pre class="CodeRay"><code class="language-sql">DELIMITER //&#x000A;<span class="r">CREATE</span> FUNCTION INET_NTOA6(n <span class="pt">DECIMAL</span>(<span class="i">39</span>) <span class="pt">UNSIGNED</span>)&#x000A;RETURNS <span class="pt">CHAR</span>(<span class="i">39</span>)&#x000A;DETERMINISTIC&#x000A;<span class="r">BEGIN</span>&#x000A;  DECLARE a <span class="pt">CHAR</span>(<span class="i">39</span>)             <span class="di">DEFAULT</span> <span class="s"><span class="dl">'</span><span class="dl">'</span></span>;&#x000A;  DECLARE i <span class="pt">INT</span>                  <span class="di">DEFAULT</span> <span class="i">7</span>;&#x000A;  DECLARE q <span class="pt">DECIMAL</span>(<span class="i">39</span>) <span class="pt">UNSIGNED</span> <span class="di">DEFAULT</span> <span class="i">0</span>;&#x000A;  DECLARE r <span class="pt">INT</span>                  <span class="di">DEFAULT</span> <span class="i">0</span>;&#x000A;  WHILE i DO&#x000A;    <span class="c">-- DIV doesn't work with nubers &gt; bigint</span>&#x000A;    <span class="r">SET</span> q <span class="er">:</span>= FLOOR(n / <span class="i">65536</span>);&#x000A;    <span class="r">SET</span> r <span class="er">:</span>= n MOD <span class="i">65536</span>;&#x000A;    <span class="r">SET</span> n <span class="er">:</span>= q;&#x000A;    <span class="r">SET</span> a <span class="er">:</span>= CONCAT_WS(<span class="s"><span class="dl">'</span><span class="k">:</span><span class="dl">'</span></span>, LPAD(CONV(r, <span class="i">10</span>, <span class="i">16</span>), <span class="i">4</span>, <span class="s"><span class="dl">'</span><span class="k">0</span><span class="dl">'</span></span>), a);&#x000A;&#x000A;    <span class="r">SET</span> i <span class="er">:</span>= i - <span class="i">1</span>;&#x000A;  <span class="r">END</span> WHILE;&#x000A;&#x000A;  <span class="r">SET</span> a <span class="er">:</span>= TRIM(TRAILING <span class="s"><span class="dl">'</span><span class="k">:</span><span class="dl">'</span></span> <span class="r">FROM</span> CONCAT_WS(<span class="s"><span class="dl">'</span><span class="k">:</span><span class="dl">'</span></span>,&#x000A;                                            LPAD(CONV(n, <span class="i">10</span>, <span class="i">16</span>), <span class="i">4</span>, <span class="s"><span class="dl">'</span><span class="k">0</span><span class="dl">'</span></span>),&#x000A;                                            a));&#x000A;&#x000A;  RETURN a;&#x000A;&#x000A;<span class="r">END</span>;&#x000A;//&#x000A;DELIMITER ;</code></pre>
      
      <p>The code is to be regarded as a proof of concept as it needs sanity
        checks and handling of simplified address notations before
        production use. However the following small test verifies that it is
        not completely broken:
      
      </p><div class="CodeRay">
      <pre>&#x000A;mysql&gt; <strong>SELECT INET_NTOA6(INET_ATON6(</strong>&#x000A;    -&gt;   <strong>'2001:0db8:85a3:0000:0000:8a2e:0370:7334'));</strong>&#x000A;+-------------------------------------------------------------------+&#x000A;| INET_NTOA6(INET_ATON6('2001:0db8:85a3:0000:0000:8a2e:0370:7334')) |&#x000A;+-------------------------------------------------------------------+&#x000A;| 2001:0DB8:85A3:0000:0000:8A2E:0370:7334                           |&#x000A;+-------------------------------------------------------------------+&#x000A;1 row in set (0.00 sec)&#x000A;&#x000A;mysql&gt; <strong>SELECT INET_NTOA6(INET_ATON6(</strong>&#x000A;    -&gt;   <strong>'ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff'));</strong>&#x000A;+-------------------------------------------------------------------+&#x000A;| INET_NTOA6(INET_ATON6('ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff')) |&#x000A;+-------------------------------------------------------------------+&#x000A;| FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF                           |&#x000A;+-------------------------------------------------------------------+&#x000A;1 row in set (0.00 sec)&#x000A;&#x000A;mysql&gt; <strong>select INET_NTOA6(INET_ATON6(</strong>&#x000A;    -&gt;   <strong>'0000:0000:0000:0000:0000:0000:0000:0000'));</strong>&#x000A;+-------------------------------------------------------------------+&#x000A;| INET_NTOA6(INET_ATON6('0000:0000:0000:0000:0000:0000:0000:0000')) |&#x000A;+-------------------------------------------------------------------+&#x000A;| 0000:0000:0000:0000:0000:0000:0000:0000                           |&#x000A;+-------------------------------------------------------------------+&#x000A;1 row in set (0.01 sec)</pre>
      </div>
      <hr>
      <div class='sponsor'>
        <a href='http://redpill-linpro.com' target='_blank'>
          <img alt='Redpill Linpro' src='../rplp.gif'>
        </a>
      </div>
      <div id='disqus_thread'></div>
      <script src='http://disqus.com/forums/km-oierud/embed.js' type='text/javascript'></script>
      <noscript>
        <a href='http://disqus.com/forums/km-oierud/?url=ref'>View the discussion thread.</a>
      </noscript>
      <a class='dsq-brlink' href='http://disqus.com'>blog comments powered by <span class="logo-disqus">Disqus</span></a></a>
    </div>
  </body>
</html>
