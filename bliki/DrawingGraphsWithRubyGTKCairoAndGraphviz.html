<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='content-type'>
    <title>
      Kjell-Magne Øierud :: bliki :: Drawing graphs with Ruby, GTK, Cairo, and Graphviz
    </title>
    <link href='/bliki/feed.atom' rel='alternate' title='Feed' type='application/atom+xml'>
    <link href='/css/coderay.css' rel='stylesheet' type='text/css'>
    <link href='/css/site.css' media='screen, projection' rel='stylesheet' type='text/css'>
    <script src='/main.js' type='text/javascript'></script>
  </head>
  <body>
    <div id='container'>
      <h1>Kjell-Magne Øierud :: Bliki</h1>
      <p id='subtitle'>Thoughts on software development</p>
      <div id='menu'>
        <span style="float:left;">[ <a href="..">Home</a> ] [ <a href="."><strong>Blog</strong></a> ] </span><span style="float: right;">[ <a href="feed.atom">Feed</a> ]</span>
      </div>
      <div class="date">
        2008-10-20 20:47 CEST
      </div>
      <h2>
        Drawing graphs with Ruby, GTK, Cairo, and Graphviz
      </h2>
      
      
      <p>Recently I wrote a prototype where I needed a quick solution for
        automatically laying out and drawing undirected graphs. The
        prototype was written in Ruby using GTK for the GUI.
      
      </p><p>I post here a small program which illustrates the basics on how this
        can be done, with a hope that it might be useful to others. To save
        some cut n' paste, you can download the source file from <a href="https://gist.github.com/1315902">this gist</a>.
      
      </p><p>Here is a sneak peek on the result.
      
      </p><div class="illustration"><img src="/images/drawing_graphs.png" alt="The result"></div>
      
      <p>First we need a simple example graph to work with. Let us define a
        graph as an array of edges. Each edge is an array with two vertices,
        represented by symbols.
      
      </p><pre class="CodeRay"><code class="language-ruby"><span class="dt">#!/usr/bin/env ruby -w</span>&#x000A;&#x000A;edges = [[<span class="sy">:a</span>, <span class="sy">:b</span>], &#x000A;         [<span class="sy">:a</span>, <span class="sy">:c</span>], &#x000A;         [<span class="sy">:b</span>, <span class="sy">:c</span>], &#x000A;         [<span class="sy">:c</span>, <span class="sy">:d</span>],&#x000A;         [<span class="sy">:d</span>, <span class="sy">:e</span>],&#x000A;         [<span class="sy">:d</span>, <span class="sy">:f</span>],&#x000A;         [<span class="sy">:e</span>, <span class="sy">:f</span>],&#x000A;        ]</code></pre>
      
      <p>The next thing is to calculate a layout of the vertices. To do this
        I use the neato command from <a href="http://graphviz.org">Graphviz</a>. Neato is a program for
        drawing undirected graphs. Graphviz expects its input to be in the
        <a href="http://en.wikipedia.org/wiki/DOT_language">dot
        language</a>.
      
      </p><pre class="CodeRay"><code class="language-ruby">dot = <span class="s"><span class="dl">"</span><span class="k">graph Test {</span><span class="ch">\n</span><span class="dl">"</span></span>&#x000A;edges.each <span class="r">do</span> |edge|&#x000A;  dot &lt;&lt; <span class="s"><span class="dl">"</span><span class="k">    </span><span class="il"><span class="idl">#{</span>edge[<span class="i">0</span>].to_s<span class="idl">}</span></span><span class="k"> -- </span><span class="il"><span class="idl">#{</span>edge[<span class="i">1</span>].to_s<span class="idl">}</span></span><span class="k">;</span><span class="ch">\n</span><span class="dl">"</span></span>&#x000A;<span class="r">end</span>&#x000A;dot &lt;&lt; <span class="s"><span class="dl">"</span><span class="k">}</span><span class="ch">\n</span><span class="dl">"</span></span>&#x000A;<span class="co">EOT</span></code></pre>
      
      <p>Interaction with neato is done using a pipe, and giving it the
        argument <code>-Tplain</code> produces a graph to stdout with layout
        information. The output format is described <a href="http://www.graphviz.org/content/output-formats#dplain">here</a>.
      
      </p><pre class="CodeRay"><code class="language-ruby">layout = <span class="co">IO</span>.popen(<span class="s"><span class="dl">'</span><span class="k">neato -Tplain</span><span class="dl">'</span></span>, <span class="s"><span class="dl">'</span><span class="k">r+</span><span class="dl">'</span></span>) <span class="r">do</span> |pipe|&#x000A;  pipe.write(dot)&#x000A;  pipe.close_write&#x000A;  pipe.read&#x000A;<span class="r">end</span></code></pre>
      
      <p>Before we proceed, we need to define some variables. Their use
        should be fairly obvious later on.
      
      </p><pre class="CodeRay"><code class="language-ruby">vertex_coordinates = {}&#x000A;padding            = <span class="i">20</span>&#x000A;scale              = <span class="i">100</span></code></pre>
      
      <p>Now we can parse the layout information.
      
      </p><pre class="CodeRay"><code class="language-ruby">layout.each <span class="r">do</span> |line|&#x000A;  <span class="r">if</span> line =~ <span class="rx"><span class="dl">/</span><span class="k">^node (</span><span class="ch">\w</span><span class="k">+)  ([</span><span class="ch">\d</span><span class="k">.]+) ([</span><span class="ch">\d</span><span class="k">.]+)</span><span class="dl">/</span></span>&#x000A;    vertex_coordinates[<span class="gv">$1</span>.to_sym] = [<span class="gv">$2</span>.to_f * scale + padding, &#x000A;                                     <span class="gv">$3</span>.to_f * scale + padding]&#x000A;  <span class="r">end</span>&#x000A;<span class="r">end</span></code></pre>
      
      <p>Then we create a window to put the drawing inside, using the <a href="http://ruby-gnome2.sourceforge.jp/">gtk2</a> library.
      
      </p><pre class="CodeRay"><code class="language-ruby">require <span class="s"><span class="dl">'</span><span class="k">gtk2</span><span class="dl">'</span></span>&#x000A;&#x000A;window = <span class="co">Gtk</span>::<span class="co">Window</span>.new(<span class="s"><span class="dl">'</span><span class="k">Graph</span><span class="dl">'</span></span>)&#x000A;window.set_default_size(<span class="i">400</span>, <span class="i">400</span>)&#x000A;&#x000A;window.signal_connect(<span class="s"><span class="dl">'</span><span class="k">destroy</span><span class="dl">'</span></span>) <span class="r">do</span>&#x000A;  <span class="co">Gtk</span>.main_quit&#x000A;<span class="r">end</span></code></pre>
      
      <p>And here is the code which draws the graph. The code uses the <a href="http://www.cairographics.org/">Cairo</a> vector drawing
        library in a GTK::DrawingArea.
      
      </p><pre class="CodeRay"><code class="language-ruby">area = <span class="co">Gtk</span>::<span class="co">DrawingArea</span>.new&#x000A;area.signal_connect(<span class="s"><span class="dl">'</span><span class="k">expose_event</span><span class="dl">'</span></span>) <span class="r">do</span>&#x000A;  context = area.window.create_cairo_context&#x000A;&#x000A;  <span class="c"># Draw the edges as straight lines between the centers of the</span>&#x000A;  <span class="c"># vertices.</span>&#x000A;  edges.each <span class="r">do</span> |edge|&#x000A;    context.move_to(*vertex_coordinates[edge[<span class="i">0</span>]])&#x000A;    context.line_to(*vertex_coordinates[edge[<span class="i">1</span>]])&#x000A;    context.stroke&#x000A;  <span class="r">end</span>&#x000A;&#x000A;  vertex_coordinates.each <span class="r">do</span> |v, c|&#x000A;    <span class="c"># Draw the vertex as a circle filled with white (this hides</span>&#x000A;    <span class="c"># the edges underneath)</span>&#x000A;    context.arc(c[<span class="i">0</span>], c[<span class="i">1</span>], <span class="i">20</span>, <span class="i">0</span>, <span class="fl">2.0</span> * <span class="co">Math</span>::<span class="co">PI</span>)&#x000A;    context.set_source_rgb(<span class="i">1</span>, <span class="i">1</span>, <span class="i">1</span>)&#x000A;    context.fill_preserve()&#x000A;    context.set_source_rgb(<span class="i">0</span>, <span class="i">0</span>, <span class="i">0</span>)&#x000A;    context.stroke&#x000A;&#x000A;    <span class="c"># Draw the vertex labels</span>&#x000A;    context.set_font_size(<span class="i">16</span>)&#x000A;    context.select_font_face(<span class="s"><span class="dl">'</span><span class="k">Arial</span><span class="dl">'</span></span>, <span class="s"><span class="dl">'</span><span class="k">normal</span><span class="dl">'</span></span>, <span class="s"><span class="dl">'</span><span class="k">bold</span><span class="dl">'</span></span>);&#x000A;    context.move_to(c[<span class="i">0</span>] - <span class="i">6</span>, c[<span class="i">1</span>] + <span class="i">5</span>)&#x000A;    context.show_text(v.to_s.upcase)&#x000A;    context.stroke&#x000A;  <span class="r">end</span>&#x000A;<span class="r">end</span></code></pre>
      
      <p>Finally we add the drawing to the window and start the application.
      
      </p><pre class="CodeRay"><code class="language-ruby">window.add(area)&#x000A;window.show_all&#x000A;&#x000A;<span class="co">Gtk</span>.main</code></pre>
      
      <p>THE END</p>
      <hr>
      <div class='sponsor'>
        <a href='http://redpill-linpro.com' target='_blank'>
          <img alt='Redpill Linpro' src='/images/rplp.gif'>
        </a>
      </div>
      <div id='disqus_thread'></div>
      <script type='text/javascript'>
        var disqus_identifier = DrawinggraphswithRubyGTKCairoandGraphviz
      </script>
      <script src='http://disqus.com/forums/km-oierud/embed.js' type='text/javascript'></script>
      <noscript>
        <a href='http://disqus.com/forums/km-oierud/?url=ref'>View the discussion thread.</a>
      </noscript>
      <a class='dsq-brlink' href='http://disqus.com'>blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </body>
</html>
