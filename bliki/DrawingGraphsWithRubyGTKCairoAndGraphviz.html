<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <title>Kjell-Magne Øierud :: bliki :: Drawing graphs with Ruby, GTK, Cairo, and Graphviz</title>
    <meta name="author" content="" />

    <link href="http://oierud.name/~kjellm/bliki/feed.atom" title="Feed" rel="alternate" type="application/atom+xml" />



    <!-- CodeRay syntax highlighting CSS -->
    <link href="http://oierud.name/~kjellm/css/coderay.css" rel="stylesheet" type="text/css" />
 
    <!-- Homepage CSS -->
    <link href="http://oierud.name/~kjellm/css/site.css" rel="stylesheet" media="screen, projection" type="text/css" />

    <script src="http://oierud.name/~kjellm/main.js" type="text/javascript"></script>
  </head>
  <body>
    <div id="container">
      <h1>Kjell-Magne Øierud :: Bliki</h1>

      <p id="subtitle">Thoughts on software development
  
      </p><div id="menu"><span style="float:left;">[ <a href="..">Home</a> ] [ <a href="."><strong>Blog</strong></a> ] [ <a href="../code">Code</a> ]</span><span style="float: right;">[ <a href="feed.atom">Feed</a> ]</span></div>
      


      <div class="date">2008-10-20 20:47 CEST</div>

<h2>Drawing graphs with Ruby, GTK, Cairo, and Graphviz</h2>


<p>Recently I wrote a prototype where I needed a quick solution for
  automatically laying out and drawing undirected graphs. The
  prototype was written in Ruby using GTK for the GUI.

</p><p>I post here a small program wich illustrates the basics on how this
  can be done, with a hope that it might be useful to others. To save
  some cut n' paste, you can download the source file from <a href="../code/">this page</a>.

</p><p>Here is a sneak peek on the result.

</p><div class="illustration"><img src="drawing_graphs.png" alt="The result" /></div>

<p>First we need a simple example graph to work with. Let us define a
  graph as an array of edges. Each edge is an array with two vertices,
  represented by symbols.

</p><div class="CodeRay">
<pre><span class="dt">#!/usr/bin/env ruby -w</span>

edges = [[<span class="sy">:a</span>, <span class="sy">:b</span>], 
         [<span class="sy">:a</span>, <span class="sy">:c</span>], 
         [<span class="sy">:b</span>, <span class="sy">:c</span>], 
         [<span class="sy">:c</span>, <span class="sy">:d</span>],
         [<span class="sy">:d</span>, <span class="sy">:e</span>],
         [<span class="sy">:d</span>, <span class="sy">:f</span>],
         [<span class="sy">:e</span>, <span class="sy">:f</span>],
        ]

</pre>
</div>
<p>The next thing is to calculate a layout of the vertices. To do this
  I use the neato command from <a href="http://graphviz.org">Graphviz</a>. Neato is a program for
  drawing undirected graphs. Graphviz expects its input to be in the
  <a href="http://en.wikipedia.org/wiki/DOT_language">dot
  language</a>.

</p><div class="CodeRay">
<pre>dot = <span class="s"><span class="dl">&quot;</span><span class="k">graph Test {</span><span class="ch">\n</span><span class="dl">&quot;</span></span>
edges.each <span class="r">do</span> |edge|
  dot &lt;&lt; <span class="s"><span class="dl">&quot;</span><span class="k">    </span><span class="il"><span class="idl">#{</span>edge[<span class="i">0</span>].to_s<span class="idl">}</span></span><span class="k"> -- </span><span class="il"><span class="idl">#{</span>edge[<span class="i">1</span>].to_s<span class="idl">}</span></span><span class="k">;</span><span class="ch">\n</span><span class="dl">&quot;</span></span>
<span class="r">end</span>
dot &lt;&lt; <span class="s"><span class="dl">&quot;</span><span class="k">}</span><span class="ch">\n</span><span class="dl">&quot;</span></span>
</pre>
</div>
<p>Interaction with neato is done using a pipe, and giving it the
  argument <code>-Tplain</code> produces a graph to stdout with layout
  information. The output format is described <a href="http://www.graphviz.org/cvs/doc/info/output.html#d:plain">here</a>.

</p><div class="CodeRay">
<pre>layout = <span class="co">IO</span>.popen(<span class="s"><span class="dl">'</span><span class="k">neato -Tplain</span><span class="dl">'</span></span>, <span class="s"><span class="dl">'</span><span class="k">r+</span><span class="dl">'</span></span>) <span class="r">do</span> |pipe|
  pipe.write(dot)
  pipe.close_write
  pipe.read
<span class="r">end</span>
</pre>
</div>
<p>Before we proceed, we need to define some variables. Their use
  should be fairly obvious later on.

</p><div class="CodeRay">
<pre>vertex_coordinates = {}
padding            = <span class="i">20</span>
scale              = <span class="i">100</span>
</pre>
</div>
<p>Now we can parse the layout information.

</p><div class="CodeRay">
<pre>layout.each <span class="r">do</span> |line|
  <span class="r">if</span> line =~ <span class="rx"><span class="dl">/</span><span class="k">^node (</span><span class="ch">\w</span><span class="k">+)  ([</span><span class="ch">\d</span><span class="k">.]+) ([</span><span class="ch">\d</span><span class="k">.]+)</span><span class="dl">/</span></span>
    vertex_coordinates[<span class="gv">$1</span>.to_sym] = [<span class="gv">$2</span>.to_f * scale + padding, 
                                     <span class="gv">$3</span>.to_f * scale + padding]
  <span class="r">end</span>
<span class="r">end</span>
</pre>
</div>
<p>Then we create a window to put the drawing inside, using the <a href="http://ruby-gnome2.sourceforge.jp/">gtk2</a> library.

</p><div class="CodeRay">
<pre>require <span class="s"><span class="dl">'</span><span class="k">gtk2</span><span class="dl">'</span></span>

window = <span class="co">Gtk</span>::<span class="co">Window</span>.new(<span class="s"><span class="dl">'</span><span class="k">Graph</span><span class="dl">'</span></span>)
window.set_default_size(<span class="i">400</span>, <span class="i">400</span>)

window.signal_connect(<span class="s"><span class="dl">'</span><span class="k">destroy</span><span class="dl">'</span></span>) <span class="r">do</span>
  <span class="co">Gtk</span>.main_quit
<span class="r">end</span>
</pre>
</div>
<p>And here is the code which draws the graph. The code uses the <a href="http://www.cairographics.org/">Cairo</a> vector drawing
  library in a GTK::DrawingArea.

</p><div class="CodeRay">
<pre>area = <span class="co">Gtk</span>::<span class="co">DrawingArea</span>.new
area.signal_connect(<span class="s"><span class="dl">'</span><span class="k">expose_event</span><span class="dl">'</span></span>) <span class="r">do</span>
  context = area.window.create_cairo_context

  <span class="c"># Draw the edges as straight lines between the centers of the</span>
  <span class="c"># vertices.</span>
  edges.each <span class="r">do</span> |edge|
    context.move_to(*vertex_coordinates[edge[<span class="i">0</span>]])
    context.line_to(*vertex_coordinates[edge[<span class="i">1</span>]])
    context.stroke
  <span class="r">end</span>

  vertex_coordinates.each <span class="r">do</span> |v, c|
    <span class="c"># Draw the vertex as a circle filled with white (this hides</span>
    <span class="c"># the edges underneath)</span>
    context.arc(c[<span class="i">0</span>], c[<span class="i">1</span>], <span class="i">20</span>, <span class="i">0</span>, <span class="fl">2.0</span> * <span class="co">Math</span>::<span class="co">PI</span>)
    context.set_source_rgb(<span class="i">1</span>, <span class="i">1</span>, <span class="i">1</span>)
    context.fill_preserve()
    context.set_source_rgb(<span class="i">0</span>, <span class="i">0</span>, <span class="i">0</span>)
    context.stroke

    <span class="c"># Draw the vertex labels</span>
    context.set_font_size(<span class="i">16</span>)
    context.select_font_face(<span class="s"><span class="dl">'</span><span class="k">Arial</span><span class="dl">'</span></span>, <span class="s"><span class="dl">'</span><span class="k">normal</span><span class="dl">'</span></span>, <span class="s"><span class="dl">'</span><span class="k">bold</span><span class="dl">'</span></span>);
    context.move_to(c[<span class="i">0</span>] - <span class="i">6</span>, c[<span class="i">1</span>] + <span class="i">5</span>)
    context.show_text(v.to_s.upcase)
    context.stroke
  <span class="r">end</span>
<span class="r">end</span>
</pre>
</div>
<p>Finally we add the drawing to the window and start the application.

</p><div class="CodeRay">
<pre>window.add(area)
window.show_all

<span class="co">Gtk</span>.main
</pre>
</div>
<p>THE END


      </p><hr />
<div class="sponsor">
  <a href="http://redpill-linpro.com" target="_blank"><img src="../rplp.gif" alt="Redpill Linpro" /></a>
</div>


      <div id="disqus_thread"></div><script src="http://disqus.com/forums/km-oierud/embed.js" type="text/javascript"></script><noscript><a href="http://disqus.com/forums/km-oierud/?url=ref">View the discussion thread.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </body>
</html>
